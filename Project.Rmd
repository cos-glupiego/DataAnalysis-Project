---
title: "Project"
output:

  html_document: 
    highlight: espresso
    theme: united
---

```{r include=FALSE}
download.file("https://github.com/cos-glupiego/DataAnalysis-Project/blob/49882f1a0f33f56a62610c276a9848d04758ca60/Lidl.csv?raw=true", destfile = "lidl.csv", mode="wb")
Lidl <- read.csv("lidl.csv")

library(dplyr)
library(tidyverse)
library(naniar)
library(editrules)
library(ggplot2)
library(tibble)
library(summarytools)
library(visdat)
library(simputation)
library(ggdist)
library(qwraps2)
library(arsenal)
library(e1071)
library(haven)
library(papeR)
library(classInt)
library(pastecs)
library(reporttools)
library(desctable)
library(psych)
library(frequency)
library(ggpubr)
library(ggforce)
library(gghalves)
library(gtsummary)
library(AER)
library(ggstatsplot)
library(report)
library(ggthemes)
library(kableExtra)
library(dlookr)

```

### Introduction

### Data visualization, wrangling and cleansing

```{r include=FALSE}
lidlclean <- Lidl %>%
  select(-ind1, -ind2)
```

## Visualisation of Outliers in the Lidl dataset

```{r Outliers detection, echo=FALSE}
boxplot(Lidl$Sales, main = "Sales Outliers") 
  boxplot(Lidl$Quantity, main = "Quantity Outliers")
  boxplot(Lidl$Profit, main = "Profit Outliers")
```

## Imputation of Outliers in the variable Profit 

```{r Imputation of Profit, echo=FALSE, cache=TRUE}
lidlcleaner <- lidlclean %>%
  mutate(Profit=imputate_outlier(lidlclean, Profit, method = "capping", cap_ntiles=c(0.1, 0.9), no_attrs = TRUE))
summary(lidlcleaner$Profit)
```

## Imputation of Outliers in the variable Sales

```{r Imputation of Sales Outliers, echo=FALSE}
  lidlcleaner$Sales <- imputate_outlier(lidlclean, Sales, method = "capping", cap_ntiles=c(0.1, 0.9), no_attrs = TRUE)
summary(lidlcleaner$Sales)
```

## Checking wether there are any missing values in the numerical variables

```{r Checking for missing values}
any_na(lidlcleaner$Profit)
any_na(lidlcleaner$Sales)
any_na(lidlcleaner$Quantity)
```
## Visualisation of imputated variables

```{r echo=FALSE}
boxplot(lidlcleaner$Profit, main = "Profit Outliers after imputation")
boxplot(lidlcleaner$Sales, main = "Sales Outliers after imputation")
```

## The distribution of mainly examined variable profit

```{r tai, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
tab1<-classIntervals(lidlcleaner$Profit,n=10,style="kmeans")
jenks.tests(tab1)

limits<-cut(lidlcleaner$Profit,seq(-40,70,by=11))
tabela1<-freq(limits,type="html")
kbl(tabela1) %>%
  kable_material(c("striped", "hover"))
```

## Graphical visualization of Profit among different segments in the company

```{r histogram, echo=FALSE, message=FALSE, warning=FALSE}
attach(Lidl)
hist(lidlcleaner$Profit, breaks = "FD", col = "green", probability = TRUE,
     main = "Lidl - profit", xlim = c(-40, 70), xlab = "Profit")
lines(density(Profit[Segment == "Home Office"]), col = 2)
lines(density(Profit[Segment == "Consumer"]), col = 3)
lines(density(Profit[Segment == "Corporate"]), col = 4)
legend("topright", legend = c("Home Office", "Consumer", "Corporate"),
       col = c(2, 3, 4), lty = 1:2, horiz = FALSE, box.lty = 0, cex = 0.8)
```

## Distibution of profit in each of segments of company

```{r echo=FALSE}
ggplot(data = lidlcleaner[lidlcleaner$Profit != 0, ], aes(x = Profit)) +
  geom_density() +
  facet_wrap(~ Segment)
```

## Distribution of profit grouped by the category of products sold

```{r echo=FALSE}
lidlcleaner%>% 
select(Category, Profit)%>% 
  ggplot(aes(x = factor(Category), y = Profit, fill = factor(Category))) +
  
  # add half-violin from {ggdist} package
  stat_halfeye(
    # adjust bandwidth
    adjust = 0.5,
    # move to the right
    justification = -0.2,
    # remove the slub interval
    .width = 0,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.12,
    # removing outliers
    outlier.color = NA,
    alpha = 0.5
  ) +
  stat_dots(
    # ploting on left side
    side = "left",
    # adjusting position
    justification = 1.1,
    # adjust grouping (binning) of observations
    binwidth = 0.25
  ) +
# Themes and Labels
  labs(
    title = "RainCloud Plot on profits made by the category of product",
    x = "Product Category",
    y = "Profit",
    fill = "Category"
  ) +
  coord_flip()

```

## Most profits made by Lidl company grouped by states

```{r echo=FALSE, message=FALSE, warning=FALSE}
lidlcleaner %>%
  select(State,Profit) %>%
  group_by(State)%>%
 dplyr::summarise(sum = sum(Profit)) %>%
 arrange(desc(sum)) %>%
    top_n(10) 


```

## Graphical visualization of Profits made on different types of product grouped by company's segments

```{r facet1, echo=FALSE}
plot1 <- ggplot(lidlcleaner, aes(Profit, Category)) + 
  geom_abline() +
  geom_jitter(width = 0.1, height = 0.1) 
plot1 + facet_wrap(~Segment)
```

### Univariate analysis
## Table of profits in different regions

```{r echo=FALSE}
lidlcleaner %>% 
  select(Profit,Region) %>%
  group_by(Region) %>%
  dplyr::summarize(Min=min(Profit),
            Max=max(Profit),
            Mean=mean(Profit),
            Std_Deviation = sd(Profit),
            Median = median(Profit),
            Q1 =quantile(Profit,0.25),
            Q3 =quantile(Profit,0.75),
            Skewness=skew(Profit),
            Kurtosis=kurtosi(Profit)) %>%
  kbl() %>%
  kable_paper("striped", full_width = FALSE) %>%
  column_spec(1:2, bold = T) %>%
  row_spec(c(1,3), bold = T, color = "white", background = "#D7261E")
```

## Descriptive Statistics grouped by the regions of USA

```{r echo=FALSE}
variab <- c("Row.ID.O6G3A1.R6")


subset_data <- lidlcleaner[, !names(lidlcleaner) %in% variab]


stby(data = subset_data, 
     INDICES = subset_data$Region, 
     FUN = descr, 
     stats = "fivenum") %>%
  tb(order = 3) %>%
  knitr::kable(format = "html", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

### Bivariate Analysis

## Correlation between each numerical variable

```{r Identyfing Quantity as numerical value, include=FALSE}
lidlcleaner$Quantity <- as.numeric(lidlcleaner$Quantity)
```

```{r echo=FALSE}
ggcorrmat(
  data     = lidlcleaner,
  colors   = c("#B2182B", "white", "#4D4D4D"),
  title    = "Correlalogram for Numerical variables in the data set",
)
```


### Statistical Inference
## Test for independent samples

```{r echo=FALSE}
ggbetweenstats(
  data  = lidlcleaner,
  x     = Category,
  y     = Profit,
  type= "np",
  title = "Distribution of Profit among the categories of product sold"
)


```

pvalue is near zero what indicates that the mean profit of categories of the products differ significantly

```{r echo=FALSE}
ggbetweenstats(
  data  = lidlcleaner,
  x     = Payment.Mode,
  y     = Profit,
  type= "np",
  title = "Distribution of Profit among the payment mode"
)


```

pvalue is above the level of 0.05 what indicates that the payment mode does not differ in the amount of Profit made

```{r echo=FALSE}
grouped_gghistostats(
  data              = lidlcleaner,
  x                 = Profit,
  y                 = Segment,
  test.value        = 10,
  type              = "parametric",
  xlab              = "Profit",
  grouping.var      = Segment,
  normal.curve      = TRUE,
  normal.curve.args = list(color = "red", size = 1),
  ggtheme           = ggthemes::theme_tufte(),
  ## modify the defaults from `{ggstatsplot}` for each plot
  plotgrid.args     = list(nrow = 1),
  annotation.args   = list(title = "Profit created by different segments of company")
)
```

```{r echo=FALSE}
Lidl2<-lidlcleaner%>%
  mutate(Returns1=ifelse(Returns==1,1,0))

ggbetweenstats(
  data  = Lidl2,
  x     = Returns1,
  y     = Profit,
  title = "Distribution of profit made on the fact wether there were any returns made"
)

```

Pvalue not significant

```{r echo=FALSE}
Lidl2$Returns1 <- factor(Lidl2$Returns1,labels = c("No Returns","Returns"))
ggpiestats(
  data         = Lidl2,
  x            = Region,
  y            = Returns1,
  title        = "Returns within different regions of United States",
  legend.title = "Regions"
)


```

There is a significant difference in number of returns made between regions as pvalue is below 0.05. There is also significant difference between regions as proportions of returns differ among them.

```{r echo=FALSE}
ggbarstats(
  data             = lidlcleaner,
  x                = Payment.Mode,
  y                = Region,
  title            = "Types of payment made based on different regions of USA",
  xlab             = "Regions",
  legend.title     = "Payment mode",

)
```
