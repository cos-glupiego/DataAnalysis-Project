---
title: "Project"
output:
  html_document: default
  pdf_document: default
---

```{r include=FALSE}
download.file("https://github.com/cos-glupiego/DataAnalysis-Project/blob/49882f1a0f33f56a62610c276a9848d04758ca60/Lidl.csv?raw=true", destfile = "lidl.csv", mode="wb")
Lidl <- read.csv("lidl.csv")
library(dlookr)
library(dplyr)
library(tidyverse)
library(naniar)
library(editrules)
library(ggplot2)
library(tibble)
library(summarytools)
library(visdat)
library(simputation)
library(kableExtra)
library(ggdist)

library(qwraps2)
library(arsenal)
library(e1071)
library(haven)
library(papeR)
library(classInt)
library(pastecs)
library(reporttools)
library(desctable)
library(psych)
library(frequency)
library(ggpubr)
library(ggforce)
library(gghalves)
library(gtsummary)
library(AER)
library(ggstatsplot)
library(report)
library(ggthemes)
```

```{r}
boxplot(Lidl$Sales, main = "Sales Outliers") 
  boxplot(Lidl$Quantity, main = "Quantity Outliers")
  boxplot(Lidl$Profit, main = "Profit Outliers")


```

```{r}
  lidlclean <- Lidl %>% select(-ind1, -ind2) 

numeric_columns <- sapply(lidlclean, is.numeric)
numeric_data <- lidlclean[, numeric_columns]
par(mfrow = c(1, sum(numeric_columns)))  
for (col in names(numeric_data)) {
  boxplot(numeric_data[[col]], main = col)
}
```

```{r}
lidlcleaner <- lidlclean %>%
  mutate(Profit=imputate_outlier(lidlclean, Profit, method = "capping", cap_ntiles=c(0.1, 0.9), no_attrs = TRUE))
summary(lidlcleaner)
```

```{r}
boxplot(lidlcleaner$Profit)

```
```{r}
lidlcleaner$Quantity <- as.numeric(lidlcleaner$Quantity)
```
```{r include=FALSE}
lidlclean %>%
count(Segment)
```

```{r include=FALSE}
lidlclean %>%
count(State, sort = TRUE)
```

```{r include=FALSE}
lidlclean %>%
count(Customer.Name, sort = TRUE)
```

```{r}
  lidlcleaner <- Lidl %>% select(-ind1, -ind2)
  ggplot(lidlcleaner, aes(x = Order.Date, y = Profit)) +
    geom_line()
  

```

```{r}
lidlclean <- Lidl %>% select(-ind1, -ind2)
  ggplot(lidlclean, aes(x = Order.Date, y = Sales)) +
    geom_boxplot()
```

```{r include=FALSE}
Lidl$State <- as.factor(Lidl$State)
Lidl$Segment <- as.factor(Lidl$Segment)
Lidl$Quantity <- factor(Lidl$Quantity,ordered=TRUE)
attach(Lidl)
Lidl$Profit <- as.numeric(Lidl$Profit)
Lidl$Sales <- as.numeric(Lidl$Sales)
print(Lidl)
```

```{r tai, echo=FALSE, message=FALSE, warning=FALSE}
tab1<-classIntervals(lidlcleaner$Profit,n=10,style="kmeans")
jenks.tests(tab1)

limits<-cut(lidlcleaner$Profit,seq(-40,70,by=11))
tabela1<-freq(limits,type="html")
kbl(tabela1) %>%
  kable_material(c("striped", "hover"))
```

```{r histogram, message=FALSE, warning=FALSE}
attach(Lidl)
hist(lidlcleaner$Profit, breaks="FD", col="green", probability = TRUE,
     main="Lidl - profit",xlim=c(-40,70))
lines(density(Profit[Segment=="Home Office"]),col=2)
lines(density(Profit[Segment=="Consumer"]),col=3)
lines(density(Profit[Segment=="Corporate"]),col=4)
legend("topright", legend=c("Home Office", "Consumer", "Corporate"),
       col=c(2,3,4), lty=1:2, horiz=FALSE, box.lty=0, cex=0.8)
```

```{r}
ggplot(data=lidlcleaner,aes(x=Profit)) +
  geom_histogram(bins=10) +
  facet_wrap(~Segment)
```

```{r echo=FALSE}
lidlcleaner%>% 
select(Category, Profit)%>% 
  ggplot(aes(x = factor(Category), y = Profit, fill = factor(Category))) +
  
  # add half-violin from {ggdist} package
  stat_halfeye(
    # adjust bandwidth
    adjust = 0.5,
    # move to the right
    justification = -0.2,
    # remove the slub interval
    .width = 0,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.12,
    # removing outliers
    outlier.color = NA,
    alpha = 0.5
  ) +
  stat_dots(
    # ploting on left side
    side = "left",
    # adjusting position
    justification = 1.1,
    # adjust grouping (binning) of observations
    binwidth = 0.25
  ) +
# Themes and Labels
  labs(
    title = "RainCloud Plot on profits made by the category of produc",
    x = "Product Category",
    y = "Profit",
    fill = "rooms"
  ) +
  coord_flip()

```



```{r message=FALSE, warning=FALSE}
lidlcleaner %>%
  select(State,Profit) %>%
  group_by(State)%>%
 dplyr::summarise(sum = sum(Profit)) %>%
 arrange(desc(sum)) %>%
    top_n(10) 


```

```{r facet1, echo=FALSE}
plot1 <- ggplot(lidlcleaner, aes(Profit, Category)) + 
  geom_abline() +
  geom_jitter(width = 0.1, height = 0.1) 
plot1 + facet_wrap(~Segment)
```

# Issue with kniting

```{r kable_report2, echo=FALSE, message=FALSE, warning=FALSE}
raport <-
  list("Profits" =
       list("Min"       = ~ min(Profit),
            "Max"       = ~ max(Profit),
            "Q1"        = ~ quantile(Profit,0.25),
            "Median" = ~ round(median(Profit),2),
            "Q3"        = ~ round(quantile(Profit,0.75),2),
            "Mean" = ~ round(mean(Profit),2),
            "Sd" = ~ round(sd(Profit),2),
             "IQR" = ~ round(iqr(Profit),2),
            "Sx" = ~ round(iqr(Profit)/2,2),
            "Var %" = ~ round((sd(Profit)/mean(Profit)),2),
            "IQR Var %" = ~ round((iqr(Profit)/median(Profit)),2),
            "Skewness" = ~  round(skew(Profit),2),
             "Kurtosis" = ~  round(kurtosi(Profit),2)
            ))
tabela<-summary_table(lidlcleaner, summaries = raport, by = c("Region"))

kbl(tabela, digits = 2,
  caption="Table 1. Profit made in each of regions.(in $$$)") %>% kable_classic(full_width = F, html_font = "Cambria")%>% kable_styling(bootstrap_options = c("striped", "hover"))
```

```{r}
lidlcleaner %>%
  select(Profit,State) %>%
  tbl_summary(label= Profit ~ "Profit",digits=c(Profit)~2,by=State,type = all_continuous() ~ "continuous2", statistic = all_continuous() ~ c("{N_nonmiss}", "{median} ({p25}, {p75})", "{min}, {max}"),missing = "no") 
```

# No display

```{r results="asis"}
dfSummary(lidlcleaner,
          plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE,
          tmp.img.dir  = "/tmp") 
```

```{r warning=FALSE, results="asis"}
(stats_by_regions <- stby(data      = lidlcleaner, INDICES   = lidlcleaner$Region, FUN       = descr, stats     = "common", transpose = TRUE)) 
```

```{r}
lidlcleaner%>%
  descr(stats = "common") %>%
  tb()
```

```{r}
grouped_descr <- stby(data    = lidlcleaner,INDICES = lidlcleaner$Region, FUN     = descr, stats   = "common")

grouped_descr %>% tb()

```

# Error in display

```{r}
stby(data    = lidlcleaner, 
     INDICES = lidlcleaner$Region, 
     FUN     = descr, 
     stats   = "fivenum") %>%
  tb(order = 3) %>%
  kable(format = "html", digits = 2) %>%
  collapse_rows(columns = 1, valign = "top")
```

### Statistical Inference

## Correlation testing
```{r}
ggcorrmat(
  data     = lidlcleaner,
  colors   = c("#B2182B", "white", "#4D4D4D"),
  title    = "Correlalogram for Numerical variables in the data set",
  subtitle = "sleep units: hours; weight units: kilograms"
)
```
## Test for independent samples

```{r}
ggbetweenstats(
  data  = lidlcleaner,
  x     = Category,
  y     = Profit,
  type= "np",
  title = "Distribution of Profit among the categories of product sold"
)


```

pvalue is near zero what indicates that the mean profit of categories of the products differ significantly

```{r}
ggbetweenstats(
  data  = lidlcleaner,
  x     = Payment.Mode,
  y     = Profit,
  type= "np",
  title = "Distribution of Profit among the payment mode"
)


```

pvalue is above the level of 0.05 what indicates that the payment mode does not differ in the amount of Profit made

```{r}
grouped_gghistostats(
  data              = lidlcleaner,
  x                 = Profit,
  y                 = Segment,
  test.value        = 10,
  type              = "parametric",
  xlab              = "Profit",
  grouping.var      = Segment,
  normal.curve      = TRUE,
  normal.curve.args = list(color = "red", size = 1),
  ggtheme           = ggthemes::theme_tufte(),
  ## modify the defaults from `{ggstatsplot}` for each plot
  plotgrid.args     = list(nrow = 1),
  annotation.args   = list(title = "Profit created by different segments of company")
)
```

```{r}
Lidl2<-lidlcleaner%>%
  mutate(Returns1=ifelse(Returns==1,1,0))

ggbetweenstats(
  data  = Lidl2,
  x     = Returns1,
  y     = Profit,
  title = "Distribution of profit made on the fact wether there were any returns made"
)

```

Pvalue not significant

```{r}
Lidl2$Returns1 <- factor(Lidl2$Returns1,labels = c("No Returns","Returns"))
ggpiestats(
  data         = Lidl2,
  x            = Region,
  y            = Returns1,
  title        = "Returns within different regions of United States",
  legend.title = "Regions"
)


```

There is a significant difference in number of returns made between regions as pvalue is below 0.05. There is also significant difference between regions as proportions of returns differ among them.

```{r}
ggbarstats(
  data             = lidlcleaner,
  x                = Payment.Mode,
  y                = Region,
  title            = "Types of payment made based on different regions of USA",
  xlab             = "Regions",
  legend.title     = "Payment mode",

)
```


